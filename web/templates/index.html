<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISO 5807 Flowchart Generator</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'loose' });
        window.mermaidAPI = mermaid;
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f1117; color: #e4e4e7; min-height: 100vh; }
        .app-header { padding: 16px 24px; border-bottom: 1px solid #27272a; display: flex; align-items: center; justify-content: space-between; }
        .app-header h1 { font-size: 18px; font-weight: 600; color: #fafafa; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .version { font-size: 11px; color: #71717a; background: #27272a; padding: 4px 10px; border-radius: 12px; }
        .history-btn { padding: 6px 12px; font-size: 12px; border: 1px solid #3f3f46; background: transparent; color: #a1a1aa; border-radius: 6px; cursor: pointer; }
        .history-btn:hover { background: #27272a; color: #fafafa; }
        .main-layout { display: grid; grid-template-columns: 380px 1fr; height: calc(100vh - 57px); }
        .sidebar { border-right: 1px solid #27272a; overflow-y: auto; padding: 16px; }
        .preview-pane { display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .upload-zone { border: 2px dashed #3f3f46; border-radius: 12px; padding: 24px 16px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 12px; }
        .upload-zone:hover, .upload-zone.drag-over { border-color: #22d3ee; background: rgba(34,211,238,0.05); }
        .upload-zone .icon { font-size: 28px; margin-bottom: 6px; }
        .upload-zone .label { font-size: 13px; color: #a1a1aa; }
        input[type="file"] { display: none; }
        .url-row { display: flex; gap: 6px; margin-bottom: 12px; }
        .url-row input { flex: 1; padding: 8px 12px; background: #18181b; border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7; font-size: 13px; }
        .url-row input:focus { outline: none; border-color: #22d3ee; }
        .url-row input::placeholder { color: #52525b; }
        .url-row button { padding: 8px 14px; background: #27272a; border: 1px solid #3f3f46; border-radius: 8px; color: #a1a1aa; font-size: 12px; cursor: pointer; white-space: nowrap; }
        .url-row button:hover { background: #3f3f46; color: #fafafa; }
        .text-input-area { margin-bottom: 12px; }
        .text-input-area textarea { width: 100%; height: 90px; background: #18181b; border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7; padding: 10px; font-size: 13px; font-family: inherit; resize: vertical; }
        .text-input-area textarea:focus { outline: none; border-color: #22d3ee; }
        .text-input-area textarea::placeholder { color: #52525b; }
        .sample-row { display: flex; gap: 6px; margin-bottom: 12px; }
        .sample-row select { flex: 1; padding: 8px 12px; background: #18181b; border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7; font-size: 13px; }
        .sample-row button { padding: 8px 14px; background: #27272a; border: 1px solid #3f3f46; border-radius: 8px; color: #a1a1aa; font-size: 12px; cursor: pointer; }
        .sample-row button:hover { background: #3f3f46; color: #fafafa; }
        .divider { display: flex; align-items: center; gap: 10px; margin: 4px 0 12px; font-size: 11px; color: #3f3f46; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: #27272a; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; width: 100%; margin-bottom: 8px; }
        .btn-primary { background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background: #27272a; color: #a1a1aa; }
        .btn-secondary:hover { background: #3f3f46; color: #e4e4e7; }
        .btn-batch { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        .btn-batch:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .batch-options { display: none; margin-bottom: 12px; padding: 12px; background: #18181b; border: 1px solid #27272a; border-radius: 10px; }
        .batch-options.active { display: block; }
        .batch-options-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .batch-options label { font-size: 11px; color: #71717a; margin-bottom: 3px; display: block; }
        .batch-options select { width: 100%; padding: 8px 10px; background: #27272a; border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7; font-size: 12px; }
        .progress-section { display: none; margin-bottom: 16px; }
        .progress-section.active { display: block; }
        .progress-bar-track { height: 4px; background: #27272a; border-radius: 2px; overflow: hidden; margin-bottom: 8px; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #06b6d4, #22d3ee); border-radius: 2px; transition: width 0.4s ease; width: 0%; }
        .progress-msg { font-size: 13px; color: #a1a1aa; margin-bottom: 6px; }
        .progress-stages { display: flex; gap: 6px; flex-wrap: wrap; }
        .stage-pill { font-size: 11px; padding: 3px 10px; border-radius: 12px; background: #27272a; color: #71717a; }
        .stage-pill.done { background: rgba(34,211,238,0.1); color: #22d3ee; }
        .stage-pill.active { background: rgba(34,211,238,0.2); color: #22d3ee; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.6} }
        .toast-container { position: fixed; top: 70px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 10px 16px; border-radius: 8px; font-size: 13px; animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards; max-width: 360px; }
        .toast.success { background: rgba(34,197,94,0.15); color: #4ade80; border: 1px solid rgba(34,197,94,0.25); }
        .toast.error { background: rgba(239,68,68,0.15); color: #f87171; border: 1px solid rgba(239,68,68,0.25); }
        .toast.info { background: rgba(34,211,238,0.15); color: #22d3ee; border: 1px solid rgba(34,211,238,0.25); }
        @keyframes toastIn { from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)} }
        @keyframes toastOut { from{opacity:1}to{opacity:0;transform:translateY(-10px)} }
        .section-label { font-size: 11px; font-weight: 600; color: #71717a; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; margin-top: 16px; }
        .wf-card { background: #18181b; border: 1px solid #27272a; border-radius: 10px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .wf-card:hover { border-color: #3f3f46; }
        .wf-card.selected { border-color: #22d3ee; background: rgba(34,211,238,0.04); }
        .wf-card .title { font-size: 14px; font-weight: 600; color: #fafafa; margin-bottom: 4px; }
        .wf-card .meta { display: flex; gap: 10px; font-size: 11px; color: #71717a; }
        .wf-card .badge { font-size: 10px; padding: 2px 8px; border-radius: 8px; font-weight: 600; }
        .badge-low { background: rgba(34,197,94,0.1); color: #4ade80; }
        .badge-medium { background: rgba(234,179,8,0.1); color: #facc15; }
        .badge-high { background: rgba(239,68,68,0.1); color: #f87171; }
        .options-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; margin-top: 12px; }
        .options-row select { padding: 8px 10px; background: #18181b; border: 1px solid #3f3f46; border-radius: 8px; color: #e4e4e7; font-size: 12px; }
        .options-row label { font-size: 11px; color: #71717a; margin-bottom: 3px; display: block; }
        .preview-toolbar { display: flex; align-items: center; justify-content: space-between; padding: 10px 16px; border-bottom: 1px solid #27272a; background: #18181b; }
        .preview-toolbar .tab-group { display: flex; gap: 0; background: #27272a; border-radius: 8px; padding: 2px; }
        .preview-toolbar .tab-btn { padding: 5px 14px; font-size: 12px; border: none; background: transparent; color: #71717a; cursor: pointer; border-radius: 6px; font-weight: 500; }
        .preview-toolbar .tab-btn.active { background: #3f3f46; color: #fafafa; }
        .toolbar-actions { display: flex; gap: 6px; align-items: center; }
        .export-btns { display: flex; gap: 4px; }
        .export-btns button, .zoom-btns button { padding: 5px 10px; font-size: 11px; border: 1px solid #3f3f46; background: transparent; color: #a1a1aa; border-radius: 6px; cursor: pointer; }
        .export-btns button:hover, .zoom-btns button:hover { background: #27272a; color: #fafafa; }
        .zoom-btns { display: flex; gap: 2px; margin-left: 8px; border-left: 1px solid #27272a; padding-left: 8px; }
        .preview-content { flex: 1; overflow: auto; position: relative; }
        #diagramView { width: 100%; min-height: 100%; display: flex; align-items: center; justify-content: center; padding: 40px; background: #fafafa; transform-origin: center center; transition: transform 0.2s; }
        #diagramView svg { max-width: 100%; height: auto; }
        #codeView { display: none; width: 100%; height: 100%; }
        #mermaidEditor { width: 100%; height: 100%; background: #18181b; color: #22d3ee; border: none; padding: 20px; font-family: 'SF Mono','Fira Code',monospace; font-size: 13px; line-height: 1.6; resize: none; outline: none; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #52525b; font-size: 14px; gap: 10px; background: #0f1117; }
        .empty-state .icon { font-size: 44px; }
        .empty-state .shortcuts { font-size: 11px; color: #3f3f46; margin-top: 6px; }
        .stats-row { display: grid; grid-template-columns: repeat(3,1fr); gap: 6px; margin-top: 12px; }
        .stat-box { background: #18181b; border: 1px solid #27272a; border-radius: 8px; padding: 8px; text-align: center; }
        .stat-box .val { font-size: 18px; font-weight: 700; color: #22d3ee; }
        .stat-box .lbl { font-size: 10px; color: #71717a; margin-top: 2px; }
        .confidence-panel { margin-top: 12px; padding: 12px; background: #18181b; border: 1px solid #27272a; border-radius: 10px; display: none; }
        .confidence-panel.active { display: block; }
        .confidence-panel h4 { font-size: 11px; font-weight: 600; color: #71717a; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
        .conf-node { display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; border-radius: 6px; margin-bottom: 4px; font-size: 12px; transition: background 0.15s; gap: 6px; }
        .conf-node:hover { background: #27272a; }
        .conf-node .node-label-input { color: #e4e4e7; flex: 1; background: #0f1117; border: 1px solid #3f3f46; border-radius: 6px; padding: 4px 6px; min-width: 100px; font-size: 12px; }
        .conf-node .node-label-input:focus { outline: none; border-color: #22d3ee; }
        .conf-node .conf-bar-track { width: 50px; height: 3px; background: #27272a; border-radius: 2px; overflow: hidden; margin-right: 6px; }
        .conf-node .conf-bar-fill { height: 100%; border-radius: 2px; }
        .conf-node .conf-pct { font-size: 10px; color: #71717a; min-width: 28px; text-align: right; }
        .conf-node .type-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #27272a; color: #71717a; margin-left: 4px; cursor: pointer; position: relative; }
        .conf-node .type-badge:hover { background: #3f3f46; color: #e4e4e7; }
        .conf-node .edited-badge { font-size: 10px; color: #22d3ee; border: 1px solid rgba(34,211,238,0.4); border-radius: 999px; padding: 1px 6px; white-space: nowrap; }
        .type-dropdown { position: absolute; top: 100%; right: 0; margin-top: 4px; background: #27272a; border: 1px solid #3f3f46; border-radius: 8px; padding: 4px; z-index: 100; min-width: 130px; display: none; }
        .type-dropdown.open { display: block; }
        .type-dropdown button { display: block; width: 100%; padding: 5px 8px; font-size: 11px; background: transparent; border: none; color: #a1a1aa; text-align: left; cursor: pointer; border-radius: 4px; }
        .type-dropdown button:hover { background: #3f3f46; color: #fafafa; }
        .validation-panel { margin-top: 10px; padding: 10px 12px; border-radius: 8px; font-size: 12px; display: none; }
        .validation-panel.warnings { display: block; background: rgba(234,179,8,0.08); border: 1px solid rgba(234,179,8,0.2); color: #facc15; }
        .validation-panel.errors { display: block; background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); color: #f87171; }
        .validation-panel ul { list-style: none; padding: 0; }
        .validation-panel li { padding: 2px 0; }
        .validation-panel li::before { content: '\26a0'; margin-right: 6px; }
        .legend { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; padding: 8px; background: #18181b; border: 1px solid #27272a; border-radius: 8px; }
        .legend-item { display: flex; align-items: center; gap: 4px; font-size: 10px; color: #a1a1aa; }
        .legend-dot { width: 8px; height: 8px; border-radius: 2px; }
        .legend-dot.start { background: #90EE90; }
        .legend-dot.end { background: #FFB6C1; }
        .legend-dot.decision { background: #FFE4B5; }
        .legend-dot.predefined { background: #B0E0E6; }
        .legend-dot.loop { background: #E8D5F5; }
        .legend-dot.low-conf { background: transparent; border: 2px dashed #FF9800; width: 6px; height: 6px; }
        .history-drawer { position: fixed; top: 57px; right: 0; width: 320px; height: calc(100vh - 57px); background: #18181b; border-left: 1px solid #27272a; z-index: 500; transform: translateX(100%); transition: transform 0.3s ease; overflow-y: auto; padding: 16px; }
        .history-drawer.open { transform: translateX(0); }
        .history-drawer h3 { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #fafafa; }
        .history-item { padding: 10px 12px; background: #27272a; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: background 0.15s; }
        .history-item:hover { background: #3f3f46; }
        .history-item .h-title { font-size: 13px; font-weight: 500; color: #e4e4e7; }
        .history-item .h-meta { font-size: 11px; color: #71717a; margin-top: 4px; }
        .history-empty { color: #52525b; font-size: 13px; text-align: center; padding: 40px 0; }
        .fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #fafafa; z-index: 2000; display: none; overflow: auto; }
        .fullscreen-overlay.active { display: flex; align-items: center; justify-content: center; }
        .fullscreen-overlay .close-btn { position: fixed; top: 16px; right: 16px; padding: 8px 16px; background: #18181b; color: #fafafa; border: none; border-radius: 8px; cursor: pointer; z-index: 2001; font-size: 13px; }
        .fullscreen-overlay svg { max-width: 95vw; max-height: 95vh; }
        @media (max-width: 768px) {
            .main-layout { grid-template-columns: 1fr; }
            .sidebar { border-right: none; border-bottom: 1px solid #27272a; max-height: 50vh; }
            .history-drawer { width: 100%; }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <h1>&#x1f4ca; ISO 5807 Flowchart Generator</h1>
        <div class="header-right">
            <button class="history-btn" onclick="toggleHistory()">&#x1f4da; History</button>
            <span class="version">v2.1.0</span>
        </div>
    </header>
    <div class="toast-container" id="toastContainer"></div>
    <div class="history-drawer" id="historyDrawer">
        <h3>&#x1f4da; Generation History</h3>
        <div id="historyList"><div class="history-empty">No generations yet</div></div>
    </div>
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <button class="close-btn" onclick="exitFullscreen()">&#x2715; Close (Esc)</button>
        <div id="fullscreenContent"></div>
    </div>
    <div class="main-layout">
        <aside class="sidebar">
            <div class="upload-zone" id="uploadZone">
                <div class="icon">&#x1f4c4;</div>
                <div class="label">Drop file or click to browse<br><small>PDF, DOCX, TXT, MD</small></div>
                <input type="file" id="fileInput" accept=".pdf,.docx,.doc,.txt,.md">
            </div>
            <div class="url-row">
                <input type="text" id="urlInput" placeholder="https://example.com/workflow-doc">
                <button onclick="fetchURL()">&#x1f310; Fetch</button>
            </div>
            <div class="divider">or</div>
            <div class="text-input-area">
                <textarea id="textInput" placeholder="Paste workflow text here...&#10;&#10;1. Open the application&#10;2. Check if user is admin&#10;3. If admin, show admin panel&#10;4. Save changes to database"></textarea>
                <button class="btn btn-secondary" onclick="processText()">&#x1f4cb; Process Text</button>
            </div>
            <div class="sample-row">
                <select id="sampleSelect"><option value="">&#x1f4d6; Load sample workflow...</option></select>
                <button onclick="loadSample()">Load</button>
            </div>
            <div class="progress-section" id="progressSection">
                <div class="progress-msg" id="progressMsg">Processing...</div>
                <div class="progress-bar-track"><div class="progress-bar-fill" id="progressFill"></div></div>
                <div class="progress-stages" id="progressStages">
                    <span class="stage-pill" data-stage="parse">Parse</span>
                    <span class="stage-pill" data-stage="detect">Detect</span>
                    <span class="stage-pill" data-stage="analyze">Analyze</span>
                    <span class="stage-pill" data-stage="build">Build</span>
                </div>
            </div>
            <div id="workflowSection" style="display:none;">
                <div class="section-label">Detected Workflows</div>
                <div id="workflowList"></div>
                <div class="stats-row" id="statsRow"></div>
                <div class="options-row">
                    <div><label>Theme</label><select id="themeSelect" onchange="regenerate()"><option value="default">Default</option><option value="forest">Forest</option><option value="dark">Dark</option><option value="neutral">Neutral</option></select></div>
                    <div><label>Direction</label><select id="dirSelect" onchange="regenerate()"><option value="TD">Top Down</option><option value="LR">Left Right</option></select></div>
                </div>
                <button class="btn btn-primary" id="generateBtn" onclick="generateSelected()">&#x2728; Generate Flowchart</button>
                <button class="btn btn-secondary" id="resetEditsBtn" onclick="resetWorkflowEdits()" style="display:none;">Reset Edits</button>
                <button class="btn btn-batch" id="batchBtn" onclick="toggleBatchOptions()" style="display:none;">&#x1f4e6; Batch Export All</button>
                <div class="batch-options" id="batchOptions">
                    <div class="batch-options-row">
                        <div>
                            <label>Split Mode</label>
                            <select id="batchSplitMode">
                                <option value="none">None (Use Detected)</option>
                                <option value="auto">Auto Detect</option>
                                <option value="section">By Section</option>
                                <option value="subsection">By Subsection</option>
                                <option value="procedure">By Procedure</option>
                            </select>
                        </div>
                        <div>
                            <label>Format</label>
                            <select id="batchFormat">
                                <option value="png">PNG</option>
                                <option value="svg">SVG</option>
                                <option value="pdf">PDF</option>
                                <option value="html">HTML</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="executeBatchExport()" id="batchExportBtn">&#x2b07; Download ZIP</button>
                </div>
                <div class="confidence-panel" id="confidencePanel"><h4>Node Confidence</h4><div id="confidenceList"></div></div>
                <div class="validation-panel" id="validationPanel"></div>
                <div class="legend" id="legendPanel" style="display:none;">
                    <div class="legend-item"><div class="legend-dot start"></div>Start</div>
                    <div class="legend-item"><div class="legend-dot end"></div>End</div>
                    <div class="legend-item"><div class="legend-dot decision"></div>Decision</div>
                    <div class="legend-item"><div class="legend-dot predefined"></div>Predefined</div>
                    <div class="legend-item"><div class="legend-dot loop"></div>Loop</div>
                    <div class="legend-item"><div class="legend-dot low-conf"></div>Uncertain</div>
                </div>
            </div>
        </aside>
        <div class="preview-pane">
            <div class="preview-toolbar" id="previewToolbar" style="display:none;">
                <div class="tab-group">
                    <button class="tab-btn active" onclick="showView('diagram',this)">&#x1f5bc; Diagram</button>
                    <button class="tab-btn" onclick="showView('code',this)">&#x1f4dd; Code</button>
                </div>
                <div class="toolbar-actions">
                    <div class="export-btns">
                        <button onclick="exportSVG()" title="Ctrl+S">SVG</button>
                        <button onclick="exportPNG()">PNG</button>
                        <button onclick="exportMMD()">.mmd</button>
                        <button onclick="copyCode()">&#x1f4cb;</button>
                    </div>
                    <div class="zoom-btns">
                        <button onclick="zoom(0.2)" title="Zoom in">+</button>
                        <button onclick="zoom(-0.2)" title="Zoom out">&minus;</button>
                        <button onclick="zoomReset()" title="Reset zoom">1:1</button>
                        <button onclick="openFullscreen()" title="Fullscreen (F11)">&#x26f6;</button>
                    </div>
                </div>
            </div>
            <div class="preview-content">
                <div id="diagramView" style="display:none;"></div>
                <div id="codeView" style="display:none;"><textarea id="mermaidEditor" spellcheck="false"></textarea></div>
                <div class="empty-state" id="emptyState">
                    <div class="icon">&#x1f4c8;</div>
                    <div>Upload a document, paste text, or load a sample</div>
                    <div class="shortcuts">Ctrl+Enter generate &#x2022; Ctrl+S export SVG &#x2022; F11 fullscreen</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        let currentData = null;
        let selectedWorkflows = [];
        let currentMermaidCode = '';
        let currentNodeConfidence = [];
        let debounceTimer = null;
        let currentZoom = 1;
        let generationHistory = [];
        const EDIT_STATE_KEY = 'flowchart.editor.v1';
        let editStateByWorkflow = loadEditState();

        function loadEditState() {
            try {
                var raw = sessionStorage.getItem(EDIT_STATE_KEY);
                if (!raw) return {};
                var parsed = JSON.parse(raw);
                return parsed && typeof parsed === 'object' ? parsed : {};
            } catch (e) {
                return {};
            }
        }

        function persistEditState() {
            try {
                sessionStorage.setItem(EDIT_STATE_KEY, JSON.stringify(editStateByWorkflow));
            } catch (e) {}
        }

        function escapeHtml(value) {
            return String(value || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function getSelectedWorkflowId() {
            return selectedWorkflows.length ? selectedWorkflows[0] : null;
        }

        function getWorkflowEdits(workflowId) {
            if (!workflowId) return {};
            if (!editStateByWorkflow[workflowId] || typeof editStateByWorkflow[workflowId] !== 'object') {
                editStateByWorkflow[workflowId] = {};
            }
            return editStateByWorkflow[workflowId];
        }

        function setNodeEdit(workflowId, nodeId, patch) {
            if (!workflowId || !nodeId) return;
            var edits = getWorkflowEdits(workflowId);
            var current = edits[nodeId] && typeof edits[nodeId] === 'object' ? edits[nodeId] : {};
            edits[nodeId] = Object.assign({}, current, patch);
            persistEditState();
            updateResetEditsButton();
        }

        function clearWorkflowEdits(workflowId) {
            if (!workflowId || !editStateByWorkflow[workflowId]) return;
            delete editStateByWorkflow[workflowId];
            persistEditState();
            updateResetEditsButton();
        }

        function hasWorkflowEdits(workflowId) {
            var edits = getWorkflowEdits(workflowId);
            return Object.keys(edits).length > 0;
        }

        function getNodeOverrides(workflowId) {
            var edits = getWorkflowEdits(workflowId);
            var overrides = [];
            Object.keys(edits).forEach(function(nodeId) {
                var item = edits[nodeId];
                if (!item || typeof item !== 'object') return;
                var override = { id: nodeId };
                if (typeof item.type === 'string' && item.type) override.type = item.type;
                if (typeof item.label === 'string' && item.label.trim()) override.label = item.label.trim();
                if (typeof item.confidence === 'number') override.confidence = item.confidence;
                if (override.type || override.label) overrides.push(override);
            });
            return overrides;
        }

        function updateResetEditsButton() {
            var btn = document.getElementById('resetEditsBtn');
            var workflowId = getSelectedWorkflowId();
            if (!workflowId || !hasWorkflowEdits(workflowId)) {
                btn.style.display = 'none';
                return;
            }
            btn.style.display = 'block';
        }

        function resetWorkflowEdits() {
            var workflowId = getSelectedWorkflowId();
            if (!workflowId) return;
            clearWorkflowEdits(workflowId);
            toast('Edits reset for selected workflow', 'info');
            renderConfidencePanel(currentNodeConfidence);
        }

        // Init: load samples
        fetch('/api/samples').then(r => r.json()).then(d => {
            if (d.success) {
                const sel = document.getElementById('sampleSelect');
                d.samples.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.title + ' (' + s.step_count + ' steps)';
                    sel.appendChild(opt);
                });
            }
        }).catch(() => {});

        // Upload zone
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
        uploadZone.addEventListener('drop', e => {
            e.preventDefault(); uploadZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });

        // Editor live re-render
        document.getElementById('mermaidEditor').addEventListener('input', e => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => renderMermaid(e.target.value), 500);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); generateSelected(); }
            if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); exportSVG(); }
            if (e.key === 'F11') { e.preventDefault(); openFullscreen(); }
            if (e.key === 'Escape') exitFullscreen();
        });

        function toast(msg, type) {
            type = type || 'info';
            var c = document.getElementById('toastContainer');
            var t = document.createElement('div');
            t.className = 'toast ' + type;
            t.textContent = msg;
            c.appendChild(t);
            setTimeout(function() { t.remove(); }, 3000);
        }

        // SSE file upload
        async function handleFile(file) {
            var prog = document.getElementById('progressSection');
            prog.classList.add('active');
            resetStages();
            var formData = new FormData();
            formData.append('file', file);
            try {
                var response = await fetch('/api/upload-stream', { method: 'POST', body: formData });
                var reader = response.body.getReader();
                var decoder = new TextDecoder();
                var buffer = '';
                while (true) {
                    var chunk = await reader.read();
                    if (chunk.done) break;
                    buffer += decoder.decode(chunk.value, { stream: true });
                    var lines = buffer.split('\n');
                    buffer = lines.pop();
                    for (var i = 0; i < lines.length; i++) {
                        if (lines[i].startsWith('data: ')) {
                            try { handleSSE(JSON.parse(lines[i].slice(6))); } catch(ex) {}
                        }
                    }
                }
            } catch (err) {
                toast('Error: ' + err.message, 'error');
            } finally {
                prog.classList.remove('active');
            }
        }

        function handleSSE(evt) {
            if (evt.stage === 'error') { toast(evt.msg, 'error'); return; }
            if (evt.pct !== undefined) document.getElementById('progressFill').style.width = evt.pct + '%';
            if (evt.msg) document.getElementById('progressMsg').textContent = evt.msg;
            var stages = ['parse','detect','analyze','build'];
            var idx = stages.indexOf(evt.stage);
            for (var i = 0; i < stages.length; i++) {
                var p = document.querySelector('[data-stage="' + stages[i] + '"]');
                if (p) p.className = 'stage-pill' + (i < idx ? ' done' : (i === idx ? ' active' : ''));
            }
            if (evt.stage === 'done' && evt.data) {
                currentData = evt.data;
                displayWorkflows(evt.data);
                toast(evt.data.workflows.length + ' workflow(s) detected!', 'success');
            }
        }

        function resetStages() {
            document.querySelectorAll('.stage-pill').forEach(function(p) { p.className = 'stage-pill'; });
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressMsg').textContent = 'Processing...';
        }

        // URL fetch
        async function fetchURL() {
            var url = document.getElementById('urlInput').value.trim();
            if (!url) { toast('Enter a URL', 'error'); return; }
            toast('Fetching URL...', 'info');
            try {
                var res = await fetch('/api/fetch-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });
                var data = await res.json();
                if (data.success) {
                    if (data.workflows) {
                        currentData = data;
                        displayWorkflows(data);
                        toast(data.workflows.length + ' workflow(s) from URL', 'success');
                    } else if (data.workflow_text) {
                        currentData = {
                            cache_key: 'url',
                            workflows: [{ id: 'u0', title: 'URL Content', step_count: 0, decision_count: 0, confidence: 0.7, complexity: 'Medium', preview: data.workflow_text.substring(0, 200) }],
                            _direct_text: data.workflow_text
                        };
                        displayWorkflows(currentData);
                        toast('Content extracted from URL', 'success');
                    }
                } else {
                    toast(data.error, 'error');
                }
            } catch(e) {
                toast(e.message, 'error');
            }
        }

        // Sample loader
        async function loadSample() {
            var id = document.getElementById('sampleSelect').value;
            if (!id) { toast('Select a sample first', 'error'); return; }
            try {
                var res = await fetch('/api/samples/' + id);
                var data = await res.json();
                if (data.success) {
                    document.getElementById('textInput').value = data.text;
                    toast('Loaded: ' + data.title, 'success');
                    processText();
                }
            } catch(e) {
                toast(e.message, 'error');
            }
        }

        // Text processing
        async function processText() {
            var text = document.getElementById('textInput').value.trim();
            if (!text) { toast('Enter some text', 'error'); return; }
            try {
                var res = await fetch('/api/clipboard', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                var data = await res.json();
                if (data.success) {
                    if (data.multiple_workflows) {
                        currentData = data;
                        displayWorkflows(data);
                        toast(data.workflows.length + ' workflows detected!', 'success');
                    } else {
                        currentData = {
                            cache_key: data.cache_key || 'text',
                            workflows: [{ id: 's0', title: 'Pasted Workflow', step_count: 0, decision_count: 0, confidence: 0.8, complexity: 'Medium', preview: text.substring(0, 200) }],
                            _direct_text: data.workflow_text
                        };
                        displayWorkflows(currentData);
                        toast('Workflow ready!', 'success');
                    }
                } else {
                    toast(data.error, 'error');
                }
            } catch(e) {
                toast(e.message, 'error');
            }
        }

        function displayWorkflows(data) {
            var list = document.getElementById('workflowList');
            selectedWorkflows = [];
            var html = '';
            for (var i = 0; i < data.workflows.length; i++) {
                var wf = data.workflows[i];
                var bc = 'badge-' + (wf.complexity || 'medium').toLowerCase();
                var workflowId = String(wf.id || '');
                var htmlId = escapeHtml(workflowId);
                var jsId = workflowId.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                html += '<div class="wf-card" onclick="selectWorkflow(\'' + jsId + '\')" data-id="' + htmlId + '">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                html += '<div class="title">' + escapeHtml(wf.title) + '</div>';
                html += '<span class="badge ' + bc + '">' + escapeHtml(wf.complexity || 'Med') + '</span></div>';
                html += '<div class="meta"><span>' + Number(wf.step_count || 0) + ' steps</span>';
                html += '<span>' + Number(wf.decision_count || 0) + ' dec</span>';
                html += '<span>' + Math.round((wf.confidence || 0.8) * 100) + '%</span></div></div>';
            }
            list.innerHTML = html;
            if (data.summary) {
                document.getElementById('statsRow').innerHTML =
                    '<div class="stat-box"><div class="val">' + data.workflows.length + '</div><div class="lbl">Workflows</div></div>' +
                    '<div class="stat-box"><div class="val">' + (data.summary.total_steps || 0) + '</div><div class="lbl">Steps</div></div>' +
                    '<div class="stat-box"><div class="val">' + (data.summary.total_decisions || 0) + '</div><div class="lbl">Decisions</div></div>';
            }
            document.getElementById('workflowSection').style.display = 'block';
            
            // Show batch button if multiple workflows detected
            if (data.workflows.length > 1 && data.cache_key) {
                document.getElementById('batchBtn').style.display = 'block';
            } else {
                document.getElementById('batchBtn').style.display = 'none';
            }
            
            if (data.workflows.length > 0) selectWorkflow(data.workflows[0].id);
            updateResetEditsButton();
        }

        function selectWorkflow(id) {
            var cards = document.querySelectorAll('.wf-card');
            for (var i = 0; i < cards.length; i++) {
                var card = cards[i];
                card.classList.toggle('selected', card.dataset.id === id);
            }
            selectedWorkflows = id ? [id] : [];
            renderConfidencePanel(currentNodeConfidence);
            updateResetEditsButton();
        }

        // Batch Export
        function toggleBatchOptions() {
            document.getElementById('batchOptions').classList.toggle('active');
        }

        async function executeBatchExport() {
            if (!currentData || !currentData.cache_key) {
                toast('No document cached. Re-upload file.', 'error');
                return;
            }
            
            var btn = document.getElementById('batchExportBtn');
            btn.disabled = true;
            btn.textContent = 'Exporting...';
            
            try {
                var splitMode = document.getElementById('batchSplitMode').value;
                var format = document.getElementById('batchFormat').value;
                
                toast('Batch export started...', 'info');
                
                var res = await fetch('/api/batch-export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cache_key: currentData.cache_key,
                        split_mode: splitMode,
                        format: format,
                        renderer: 'graphviz',
                        extraction: 'heuristic',
                        theme: document.getElementById('themeSelect').value
                    })
                });
                
                if (res.ok) {
                    var blob = await res.blob();
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'flowcharts_' + Date.now() + '.zip';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    toast('ZIP downloaded successfully!', 'success');
                } else {
                    var err = await res.json();
                    toast(err.error || 'Export failed', 'error');
                }
            } catch(e) {
                toast('Export error: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '\u2b07 Download ZIP';
            }
        }

        async function generateSelected() {
            if (!selectedWorkflows.length) { toast('Select a workflow first', 'error'); return; }
            var btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.textContent = 'Generating...';
            try {
                var wfId = selectedWorkflows[0];
                var wfObj = null;
                for (var i = 0; i < currentData.workflows.length; i++) {
                    if (currentData.workflows[i].id === wfId) { wfObj = currentData.workflows[i]; break; }
                }
                var workflowText;
                if (currentData._direct_text) {
                    workflowText = currentData._direct_text;
                } else {
                    var wfRes = await fetch('/api/workflow/' + currentData.cache_key + '/' + wfId);
                    var wfData = await wfRes.json();
                    if (!wfData.success) throw new Error(wfData.error);
                    workflowText = wfData.workflow_text;
                }
                var theme = document.getElementById('themeSelect').value;
                var overrides = getNodeOverrides(wfId);
                var res = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        workflow_text: workflowText,
                        title: wfObj ? wfObj.title : 'Workflow',
                        theme: theme,
                        validate: true,
                        node_overrides: overrides
                    })
                });
                var data = await res.json();
                if (data.success) {
                    currentMermaidCode = data.mermaid_code;
                    currentNodeConfidence = data.node_confidence || [];
                    document.getElementById('mermaidEditor').value = currentMermaidCode;
                    await renderMermaid(currentMermaidCode);
                    showPreview();
                    renderConfidencePanel(currentNodeConfidence);
                    renderValidation(data.validation);
                    document.getElementById('legendPanel').style.display = 'flex';
                    addToHistory(wfObj ? wfObj.title : 'Workflow', data.stats);
                    if (data.applied_overrides) {
                        var ignoredCount = (data.applied_overrides.ignored || []).length;
                        if (ignoredCount > 0) {
                            var firstReason = data.applied_overrides.ignored[0].reason;
                            toast('Applied ' + data.applied_overrides.applied_count + ' edits; ' + ignoredCount + ' ignored (' + firstReason + ')', 'info');
                        } else if (data.applied_overrides.applied_count > 0) {
                            toast('Applied ' + data.applied_overrides.applied_count + ' edit(s)', 'success');
                        }
                    }
                    toast(data.stats.nodes + ' nodes, ' + data.stats.connections + ' connections', 'success');
                    updateResetEditsButton();
                } else {
                    toast(data.error, 'error');
                }
            } catch(e) {
                toast(e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '\u2728 Generate Flowchart';
            }
        }

        async function regenerate() {
            if (selectedWorkflows.length) await generateSelected();
        }

        async function renderMermaid(code) {
            var container = document.getElementById('diagramView');
            try {
                var id = 'mmd-' + Date.now();
                var result = await window.mermaidAPI.render(id, code);
                container.innerHTML = result.svg;
            } catch(e) {
                container.innerHTML = '<div style="color:#f87171;padding:20px;">Syntax error: ' + e.message + '</div>';
            }
        }

        function renderConfidencePanel(nodes) {
            var panel = document.getElementById('confidencePanel');
            var list = document.getElementById('confidenceList');
            if (!nodes || nodes.length === 0) { panel.classList.remove('active'); return; }
            var workflowId = getSelectedWorkflowId();
            var edits = getWorkflowEdits(workflowId);
            var TL = { terminator:'Term', process:'Proc', decision:'Dec', io:'I/O', database:'DB', display:'Disp', document:'Doc', predefined:'Predef', manual:'Manual', connector:'Conn' };
            var AT = ['process','decision','io','database','display','document','predefined','manual','terminator'];
            var html = '';
            for (var i = 0; i < nodes.length; i++) {
                var n = nodes[i];
                if (n.id === 'START' || n.id === 'END') continue;
                var nodeEdit = edits[n.id] && typeof edits[n.id] === 'object' ? edits[n.id] : {};
                var displayType = nodeEdit.type || n.type;
                var displayLabel = nodeEdit.label || n.label;
                var isEdited = Boolean(nodeEdit.type || nodeEdit.label);
                var pct = Math.round((n.confidence || 1) * 100);
                var color = pct >= 80 ? '#4ade80' : (pct >= 60 ? '#facc15' : '#f87171');
                var altHtml = '';
                var safeNodeId = String(n.id).replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                for (var j = 0; j < AT.length; j++) {
                    altHtml += '<button onclick="changeNodeType(\'' + safeNodeId + '\',\'' + AT[j] + '\')">' + (TL[AT[j]] || AT[j]) + '</button>';
                }
                html += '<div class="conf-node">';
                html += '<input class="node-label-input" value="' + escapeHtml(displayLabel) + '" title="' + escapeHtml(displayLabel) + '" onchange="changeNodeLabel(\'' + safeNodeId + '\', this.value)">';
                if (isEdited) html += '<span class="edited-badge">Edited</span>';
                html += '<div class="conf-bar-track"><div class="conf-bar-fill" style="width:' + pct + '%;background:' + color + '"></div></div>';
                html += '<span class="conf-pct">' + pct + '%</span>';
                html += '<span class="type-badge" onclick="event.stopPropagation();this.querySelector(\'.type-dropdown\').classList.toggle(\'open\')">';
                html += escapeHtml(TL[displayType] || displayType);
                html += '<div class="type-dropdown">' + altHtml + '</div></span></div>';
            }
            list.innerHTML = html;
            panel.classList.add('active');
            updateResetEditsButton();
        }

        function changeNodeType(nodeId, newType) {
            document.querySelectorAll('.type-dropdown').forEach(function(d) { d.classList.remove('open'); });
            for (var i = 0; i < currentNodeConfidence.length; i++) {
                if (currentNodeConfidence[i].id === nodeId) {
                    currentNodeConfidence[i].type = newType;
                    currentNodeConfidence[i].confidence = 1.0;
                    currentNodeConfidence[i].alternatives = [];
                    break;
                }
            }
            var workflowId = getSelectedWorkflowId();
            if (workflowId) setNodeEdit(workflowId, nodeId, { type: newType, confidence: 1.0 });
            renderConfidencePanel(currentNodeConfidence);
            toast('Node ' + nodeId + ' changed to ' + newType + '. Re-generate to apply.', 'info');
        }

        function changeNodeLabel(nodeId, newLabel) {
            var label = String(newLabel || '').trim();
            if (!label) {
                toast('Label cannot be empty', 'error');
                renderConfidencePanel(currentNodeConfidence);
                return;
            }
            for (var i = 0; i < currentNodeConfidence.length; i++) {
                if (currentNodeConfidence[i].id === nodeId) {
                    currentNodeConfidence[i].label = label;
                    break;
                }
            }
            var workflowId = getSelectedWorkflowId();
            if (workflowId) setNodeEdit(workflowId, nodeId, { label: label, confidence: 1.0 });
            renderConfidencePanel(currentNodeConfidence);
        }

        function renderValidation(v) {
            var p = document.getElementById('validationPanel');
            if (!v) { p.className = 'validation-panel'; return; }
            var items = [];
            if (v.errors && v.errors.length) {
                for (var i = 0; i < v.errors.length; i++) items.push('<li>' + escapeHtml(v.errors[i]) + '</li>');
                p.className = 'validation-panel errors';
            } else if (v.warnings && v.warnings.length) {
                for (var i = 0; i < v.warnings.length; i++) items.push('<li>' + escapeHtml(v.warnings[i]) + '</li>');
                p.className = 'validation-panel warnings';
            } else {
                p.className = 'validation-panel'; return;
            }
            p.innerHTML = '<ul>' + items.join('') + '</ul>';
        }

        // History
        function addToHistory(title, stats) {
            generationHistory.unshift({ title: title, stats: stats, code: currentMermaidCode, time: new Date().toLocaleTimeString() });
            if (generationHistory.length > 10) generationHistory.pop();
            renderHistory();
        }

        function renderHistory() {
            var list = document.getElementById('historyList');
            if (!generationHistory.length) {
                list.innerHTML = '<div class="history-empty">No generations yet</div>';
                return;
            }
            var html = '';
            for (var i = 0; i < generationHistory.length; i++) {
                var h = generationHistory[i];
                var nodeCount = h.stats && h.stats.nodes ? h.stats.nodes : 0;
                html += '<div class="history-item" onclick="restoreHistory(' + i + ')">';
                html += '<div class="h-title">' + escapeHtml(h.title) + '</div>';
                html += '<div class="h-meta">' + escapeHtml(h.time) + ' &#x2022; ' + Number(nodeCount) + ' nodes</div></div>';
            }
            list.innerHTML = html;
        }

        function restoreHistory(idx) {
            var h = generationHistory[idx];
            if (!h) return;
            currentMermaidCode = h.code;
            document.getElementById('mermaidEditor').value = h.code;
            renderMermaid(h.code);
            showPreview();
            toast('Restored: ' + h.title, 'info');
            toggleHistory();
        }

        function toggleHistory() {
            document.getElementById('historyDrawer').classList.toggle('open');
        }

        // Views
        function showPreview() {
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('previewToolbar').style.display = 'flex';
            document.getElementById('diagramView').style.display = 'flex';
            document.getElementById('codeView').style.display = 'none';
        }

        function showView(view, btn) {
            document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            document.getElementById('diagramView').style.display = view === 'diagram' ? 'flex' : 'none';
            document.getElementById('codeView').style.display = view === 'code' ? 'block' : 'none';
        }

        // Zoom
        function zoom(delta) {
            currentZoom = Math.max(0.3, Math.min(3, currentZoom + delta));
            document.getElementById('diagramView').style.transform = 'scale(' + currentZoom + ')';
        }

        function zoomReset() {
            currentZoom = 1;
            document.getElementById('diagramView').style.transform = 'scale(1)';
        }

        // Fullscreen
        function openFullscreen() {
            var svg = document.getElementById('diagramView').innerHTML;
            if (!svg) return;
            document.getElementById('fullscreenContent').innerHTML = svg;
            document.getElementById('fullscreenOverlay').classList.add('active');
        }

        function exitFullscreen() {
            document.getElementById('fullscreenOverlay').classList.remove('active');
        }

        // Export
        function exportSVG() {
            var s = document.getElementById('diagramView').innerHTML;
            if (!s) return;
            downloadBlob(new Blob([s], { type: 'image/svg+xml' }), 'flowchart.svg');
            toast('SVG exported', 'success');
        }

        function exportPNG() {
            var el = document.querySelector('#diagramView svg');
            if (!el) return;
            var d = new XMLSerializer().serializeToString(el);
            var c = document.createElement('canvas');
            var ctx = c.getContext('2d');
            var img = new Image();
            img.onload = function() {
                c.width = img.width * 2;
                c.height = img.height * 2;
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, c.width, c.height);
                ctx.drawImage(img, 0, 0, c.width, c.height);
                c.toBlob(function(b) {
                    downloadBlob(b, 'flowchart.png');
                    toast('PNG exported', 'success');
                }, 'image/png');
            };
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(d)));
        }

        function exportMMD() {
            if (!currentMermaidCode) return;
            downloadBlob(new Blob([currentMermaidCode], { type: 'text/plain' }), 'flowchart.mmd');
            toast('.mmd exported', 'success');
        }

        function copyCode() {
            if (!currentMermaidCode) return;
            navigator.clipboard.writeText(currentMermaidCode).then(function() {
                toast('Copied to clipboard', 'success');
            });
        }

        function downloadBlob(b, f) {
            var u = URL.createObjectURL(b);
            var a = document.createElement('a');
            a.href = u;
            a.download = f;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(u);
        }

        // Close dropdowns on outside click
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.type-badge')) {
                document.querySelectorAll('.type-dropdown').forEach(function(d) { d.classList.remove('open'); });
            }
        });
    </script>
</body>
</html>
